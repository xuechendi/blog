
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Heartbeat and DRBD internal - XueChendi</title>
  <meta name="author" content="Chendi.Xue">

  
  <meta name="description" content="This posting is talking about Heartbeat &amp; DRBD internal Every high−availability system needs two basic services: to be informed of cluster &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://xuechendi.github.io/blog/2013/12/09/heartbeat-and-drbd-internal">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="XueChendi" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>

  

</head>


<body>
	<div class="container">
		<aside class="left">
			<div class="inner-left">
				<header>
					<img src="/xuechendi.jpg?s=200" alt="Gravatar of Chendi.Xue " title="Gravatar of Chendi.Xue" class="profilepic" />
<hgroup>
  <h1><a href="/">XueChendi</a></h1>
  
    <h2 class="subtitle">Keep Simple, Keep Effecient</h2>
   
</hgroup>


				</header>
				<footer>
					<p>
	<a href="https://facebook.com/xuechendi" class="btn btn-dark">Facebook</a>
	<a href="http://cn.linkedin.com/pub/chendi-xue/5b/935/b36/" class="btn btn-dark">Linkedin</a>
</p>

				</footer>
			</div>
		</aside>
    	<section class="right">
    		<div class="inner-right">
                        <nav role="navigation">
                                <ul class="subscription" data-subscription="rss">
  <li class="rss"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:xuechendi.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/#posts">About Me</a></li>
  <li><a href="/blog/2013/11/14/resume/">Resume</a></li>
  <li><a href="/blog/archives">Blog</a></li>
</ul>


                        </nav>
    			<div id="posts">
    			  	<article class="post">
    
  <header>
    
      <h1 class="entry-title">Heartbeat and DRBD Internal</h1>
    
    
      <p class="meta">
        <!--








  


<time datetime="2013-12-09T10:20:00+08:00" pubdate data-updated="true">Dec 9<span>th</span>, 2013</time>-->
        <!--
           | <a href="#disqus_thread"
             data-disqus-identifier="http://xuechendi.github.io">Comments</a>
        -->
      </p>
    
  </header>


<div class="entry-content"><p>This posting is talking about Heartbeat &amp; DRBD internal</p>

<p>Every high−availability system needs two basic services: to be informed of cluster members joining and leaving the system, and to provide basic communication services for managing a cluster.</p>

<p>Below info is quoted from <a href="http://upcommons.upc.edu/pfc/bitstream/2099.1/4970/1/memoria.pdf" target="_blank">MASTER THESIS of Abraham Iglesias Aparicio</a></p>

<h2>The Linux-HA project: Heartbeat</h2>

<p>Linux-ha project (Linux High Availability project) [5] is an open source suite to build high available clusters. It can run on every known Linux flavor and in some Unices such as FreeBSD and Solaris.
Heartbeat software is the core component of the Linux-HA project and permits building high availability clusters from commodity servers, as it has no hardware dependencies.</p>

<p>The project started in 1998 and is maintained by an open developer’s community. The project is lead by some companies like Novell or IBM. 10 years of development, testing and more than 30.000 production clusters are numbers that would reflect project maturity.</p>

<h3>Heartbeat cluster styles</h3>

<p>There are two different scopes when working with Heartbeat. Two styles of clusters can be configured. Let us say R1 cluster style and R2 cluster style.
R1 cluster style was the first kind of configurations that could be done with Heartbeat. In this configuration there were some limitations such as:</p>

<h5>1. Limitation of nodes in the cluster (it can only accept 2 nodes)</h5>

<h5>2. Cannot perform monitor operations of a cluster resource</h5>

<h5>3. There were almost no options to express dependency information</h5>

<br>


<p>First version of this R2 cluster style was 2.0.0. At the time of writing this document, Heartbeat latest stable version was 2.0.8. Therefore, this version will be the reference of study in this project. R2 is fully compatible with R1 cluster style configuration. It supports up to 16 nodes cluster and an asynchronous logging daemon was added. Moreover, there were some improvements on message architecture.
With R2 cluster style, or next generation of Heartbeat, these limitations were overridden and software architecture changed. Adding more components and functionalities lead to a more complex system but more complete than the R1 cluster style.
Some new components appeared with R2:</p>

<h5>1. ClusterInformationBase</h5>

<h5>2. ClusterResourceManager</h5>

<h5>3. Modular PolicyEngine</h5>

<h5>4. LocalResourceManager</h5>

<h5>5. StonithDaemon</h5>

<br>


<h4>ClusterInformationBase</h4>

<p>ClusterInformationBase (aka CIB) is the component which stores information about the cluster. It is replicated on every node and stores two kind of information:</p>

<h5>1. Static information. It includes definitions of cluster nodes, resources, monitor operations and constraints.</h5>

<h5>2. Dynamic information. CIB stores the current status of the cluster.</h5>

<br>


<p>CIB is formatted in a XML document and must be built following DTD document included with Heartbeat specifications. Cib.xml files can be red in annex 2.1.</p>

<h4>ClusterResourceManager</h4>

<p>The ClusterResourceManager (CRM) component consists on the following components:</p>

<h5>1. ClusterInformationBase</h5>

<h5>2. ClusterResourceManagerDaemon</h5>

<h5>3. PolicyEngine</h5>

<h5>4. Transitioner</h5>

<h5>5. LocalResourceManager</h5>

<br>


<p>The ClusterResourceManagerDaemon (CRMD) runs on every node and coordinates the actions of all other cluster resource managers. It exchanges information with the designated coordinator (DC) and it can be seen as a communication interface between DC and subsystem components such as CIB and LocalResourceManager.</p>

<p>The DC is a special instance of CRMD. It is elected with the help of the list of cluster nodes from the ClusterConsensusManager (CCM) and takes on the responsibilities of ResourceAllocation throughout the cluster. Therefore, DC is the one who delivers CIB information to all slave instances of CRMD.</p>

<p>The PolicyEngine (PE) module is the one who performs computation of the next state in the cluster. It is triggered by any event in the cluster, such as a resource changing state, a node leaving or joining, or CRM event such as a CRM parting or leaving. The PE, takes the input from CIB and runs locally and does not do any network I/O, it only runs an algorithm. It describes the actions and their dependencies necessary to go from the current cluster state to the target cluster state.
When PE returns an action it is passed to the Transitioner. The goal of this component is to make PE’s wishes become true. The new state computed by PE is passed to the Transitioner, which communicates with the LocalResourceManager on every node and informs about the actions decided by PE (start, stop resources).</p>

<h3>ClusterConsensusManager</h3>

<p>The ClusterConsensusManager (CCM) is the one who establishes membership in the cluster. This membership layer is in the middle of Heartbeat, which is the messaging and infrastructure layer, and the new CRM which is the resource allocation layer. CCM information includes new additions to the membership, lost nodes and loss of quorum.</p>

<h3>Stonith daemon</h3>

<p>R2 cluster style features include stonith capabilities. Stonith is an acronym meaning “Shot The Other Node In The Head”.
A stonith daemon is running on every node and receives requests from the CRM’s TE about what and when to reset. An example of when stonith daemon action is used is in a split brain situation. The DC will send a message to the Stonith daemon to reset the sick node. This node will reboot and then will join the cluster again in a healthy way.</p>

<h3>LocalResourceManager</h3>

<p>Finally, the LocalResourceManager (LRM) has the responsibility for performing operations on resources, by using ResourceAgent scripts to carry out the work. ResourceAgent scripts define a set of start, stop or monitor operations, as directed by the CRM, which are used to operate on a resource instance.
LRM also provides information about resources. It can provide a list of resources that are currently primary and its current state.</p>

<h3>Configuration and manageability</h3>

<p>Heartbeat GUI is a user interface to manage Heartbeat clusters. It is delivered in a separate package of Heartbeat core. It is an application developed with python and is able to add, remove nodes or cluster resources.
It is necessary to have connectivity to port 5560/tcp of the cluster node and password for hacluster user running on the cluster nodes.
Heartbeat GUI is executed from a shell and after being authenticated, the main screen of Heartbeat GUI appears. This is how GUI looks like:</p>

<p><img src="/images/HA/heartbeat_gui.png" alt="heartbeat_gui" /></p>

<h2>HA overview</h2>

<p><img src="/images/HA/pcmk-overview.png" alt="heartbeat_gui" /></p>

<h2>HA(Pacemaker) Internal Components</h2>

<p>Pacemaker itself is composed of four key components (illustrated below in the same color scheme as the previous diagram):</p>

<h5>Heartbeat：将原来的消息通信层独立为heartbeat项目，新的heartbeat只负责维护集群各节点的信息以及它们之前通信；</h5>

<h5>Cluster Glue：相当于一个中间层，它用来将heartbeat和pacemaker关联起来，主要包含2个部分，即为LRM和STONITH。</h5>

<h5>Resource Agent：用来控制服务启停，监控服务状态的脚本集合，这些脚本将被LRM调用从而实现各种资源启动、停止、监控等等。</h5>

<h5>Pacemaker:也就是Cluster Resource Manager （简称CRM），用来管理整个HA的控制中心，客户端通过pacemaker来配置管理监控整个集群。</h5>

<h5>Corosync:a Group Communication System， helps Pacemaker to support popular open source cluster filesystems.</h5>

<pre><code>what is Corosync:
    Corosync包含OpenAIS的核心框架用来对Wilson的标准接口的使用、管理。它为商用的或开源性的集群提供集群执行框架。Corosync执行高可用应用程序的通信组系统，它有以下特征：
    一个封闭的程序组（A closed process group communication model）通信模式，这个模式提供一种虚拟的同步方式来保证能够复制服务器的状态。
    一个简单可用性管理组件（A simple availability manager），这个管理组件可以重新启动应用程序的进程当它失败后。
    一个配置和内存数据的统计（A configuration and statistics in-memory database），内存数据能够被设置，回复，接受通知的更改信息。
    一个定额的系统（A quorum  syste）,定额完成或者丢失时通知应用程序。
</code></pre>

<p><img src="/images/HA/pcmk-stack.png" alt="heartbeat_gui" /></p>

<h5>1. CIB (aka. Cluster Information Base)</h5>

<p>The CIB uses XML to represent both the cluster’s configuration and current state of all resources in the cluster. The contents of the CIB are automatically kept in sync across the entire cluster and are used by the PEngine to compute the ideal state of the cluster and how it should be achieved.</p>

<h5>2. CRMd (aka. Cluster Resource Management daemon)</h5>

<p>This list of instructions is then fed to the DC (Designated Co-ordinator). Pacemaker centralizes all cluster decision making by electing one of the CRMd instances to act as a master. Should the elected CRMd process, or the node it is on, fail… a new one is quickly established.</p>

<h5>3. PEngine (aka. PE or Policy Engine)</h5>

<p>The DC carries out the PEngine’s instructions in the required order by passing them to either the LRMd (Local Resource Management daemon) or CRMd peers on other nodes via the cluster messaging infrastructure (which in turn passes them on to their LRMd process).</p>

<p>The peer nodes all report the results of their operations back to the DC and based on the expected and actual results, will either execute any actions that needed to wait for the previous one to complete, or abort processing and ask the PEngine to recalculate the ideal cluster state based on the unexpected results.</p>

<h5>4. STONITHd</h5>

<p>In some cases, it may be necessary to power off nodes in order to protect shared data or complete resource recovery. For this Pacemaker comes with STONITHd. STONITH is an acronym for Shoot-The-Other-Node-In-The-Head and is usually implemented with a remote power switch. In Pacemaker, STONITH devices are modeled as resources (and configured in the CIB) to enable them to be easily monitored for failure, however STONITHd takes care of understanding the STONITH topology such that its clients simply request a node be fenced and it does the rest.</p>

<p><img src="/images/HA/pcmk-internals.png" alt="heartbeat_gui" /></p>

<p>A heartbeat is a periodic communication attempt to check for updated policies.</p>

<p>Heartbeat仅仅是个HA软件，它仅能完成心跳监控和资源接管，不会监视它控制的资源或应用程序。要监控资源和应用程序是否运行正常，必须使用第三方的插件，例如ipfail、Mon和Ldirector等。Heartbeat自身包含了几个插件，分别是ipfail、Stonith和Ldirectord，介绍如下。</p>

<p>ipfail的功能直接包含在Heartbeat里面，主要用于检测网络故障，并做出合理的反应。为了实现这个功能，ipfail使用ping节点或者ping节点组来检测网络连接是否出现故障，从而及时做出转移措施。</p>

<p>Stonith插件可以在一个没有响应的节点恢复后，合理接管集群服务资源，防止数据冲突。当一个节点失效后，会从集群中删除。如果不使用Stonith插件，那么失效的节点可能会导致集群服务在多于一个节点运行，从而造成数据冲突甚至是系统崩溃。因此，使用Stonith插件可以保证共享存储环境中的数据完整性。</p>

<p>Ldirector是一个监控集群服务节点运行状态的插件。Ldirector如果监控到集群节点中某个服务出现故障，就屏蔽此节点的对外连接功能，同时将后续请求转移到正常的节点提供服务。这个插件经常用在LVS负载均衡集群中。关于Ldirector插件的使用，将在后续章节详细讲述。</p>

<p>针对系统自身出现问题导致heartbeat无法监控的问题，就需要在Linux内核中启用一个叫watchdog的模块。watchdog是一个Linux内核模块，它通过定时向/dev/watchdog设备文件执行写操作，从而确定系统是否正常运行。如果watchdog认为内核挂起，就会重新启动系统，进而释放节点资源。</p>

<p>在Linux中完成watchdog功能的软件叫softdog。softdog维护一个内部计时器，此计时器在一个进程写入/dev/watchdog设备文件时更新。如果softdog没有看到进程写入/dev/watchdog文件，就认为内核可能出了故障。watchdog超时周期默认是一分钟，可以通过将watchdog集成到Heartbeat中，从而通过Heartbeat来监控系统是否正常运行。</p>
</div>


</article>


        <div class="sharing">
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>




<section id="comments">
    <div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>


    			</div>
    			<footer id="footer">
    				<p class="credit">
  Copyright &copy; 2013 - Chendi.Xue. Powered by <a href="http://octopress.org">Octopress</a>
</p>


    			</footer>
    			

<script type="text/javascript">
      var disqus_shortname = 'XueChendi';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://xuechendi.github.io/blog/2013/12/09/heartbeat-and-drbd-internal/';
        var disqus_url = 'http://xuechendi.github.io/blog/2013/12/09/heartbeat-and-drbd-internal/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>








<link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>





    		</div>
    	</section>
  	</div>
</body>
</html>
